name: DeployLocalStack
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  AWS_ACCESS_KEY_ID: giropops
  AWS_SECRET_ACCESS_KEY: stringus
  AWS_DEFAULT_REGION: us-east-1
  LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}

jobs:
  deploy:
    name: Deploy to LocalStack
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          DEBUG: 1
          DOCKER_HOST: unix:///var/run/docker.sock
        options: >-
          --health-cmd="curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          
      - name: Install LocalStack CLI
        run: |
          pip install localstack awscli-local
          
      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60s sh -c 'until curl -f http://localhost:4566/_localstack/health; do sleep 2; done'
          echo "LocalStack is ready!"
          
      - name: Configure AWS CLI for LocalStack
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region $AWS_DEFAULT_REGION
          
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.7"
          
      - name: Install Node.js dependencies
        run: npm ci
        
      - name: Build Next.js application
        run: npm run build
        
      - name: Initialize Terraform
        working-directory: ./infra_terraform
        run: terraform init
        
      - name: Plan Terraform deployment
        working-directory: ./infra_terraform
        run: terraform plan -var="use_localstack=true"
        
      - name: Deploy infrastructure to LocalStack
        working-directory: ./infra_terraform
        run: terraform apply -auto-approve -var="use_localstack=true"
        
      - name: Show Terraform Outputs
        working-directory: ./infra_terraform  
        run: |
          echo "ðŸ“‹ TERRAFORM INFRASTRUCTURE CREATED:"
          terraform output -json | jq -r 'to_entries[] | "ðŸ”¹ \(.key): \(.value.value)"'
        
      - name: Deploy Next.js to S3 website
        run: |
          echo "ðŸš€ Deploying Next.js static export to LocalStack S3..."
          
          # Verificar se o build do Next.js foi criado corretamente
          if [ ! -d "out" ]; then
            echo "âŒ Next.js static export directory 'out' not found!"
            echo "ðŸ’¡ Checking if Next.js build completed successfully..."
            ls -la . | grep -E "(out|build|dist)"
            exit 1
          fi
          
          echo "âœ… Next.js static export found, proceeding with deployment..."
          echo "ðŸ“ Files in out directory:"
          find out -type f | head -10
          
          # Run the Next.js deployment script
          chmod +x deploy-to-s3.sh
          ./deploy-to-s3.sh
          
      - name: ðŸ“Š Post-Deployment Verification  
        run: |
          echo "ðŸ” Verifying deployment..."
          
          # Wait a moment for deployment to settle
          sleep 5
          
          # Test website availability
          echo "Testing website availability..."
          if curl -f http://verison-devos-one-website.s3-website.us-east-1.localhost.localstack.cloud:4566 > /dev/null 2>&1; then
            echo "âœ… Website is accessible!"
          else
            echo "âš ï¸ Website may need a moment to become available"
          fi
          
      - name: ðŸŒ Deploy Next.js Static Export to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          publish_branch: gh-pages
          enable_jekyll: false
          commit_message: 'Deploy Next.js Static Export: ${{ github.event.head_commit.message }}'
        
      - name: Verify LocalStack deployment
        run: |
          echo "Checking LocalStack services..."
          curl -f http://localhost:4566/_localstack/health
          echo "Listing LocalStack resources..."
          awslocal s3 ls || echo "No S3 buckets found"
          awslocal s3 ls s3://verison-devos-one-website || echo "Website bucket not found"
          echo "Checking website bucket configuration..."
          awslocal s3api get-bucket-website --bucket verison-devos-one-website || echo "Website configuration not found"
          
      - name: ðŸŒ Website Ready - Access Your Deployment
        run: |
          echo ""
          echo "ðŸŽ‰ =================================="
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "ðŸŒ Website is now live and ready!"
          echo "===================================="
          echo ""
          echo "ðŸ“ ACCESS YOUR WEBSITE:"
          echo "ðŸ”— LocalStack (during CI run): http://verison-devos-one-website.s3-website.us-east-1.localhost.localstack.cloud:4566"
          echo "ðŸ”— GitHub Pages (permanent): https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "ðŸ“Š DEPLOYMENT DETAILS:"
          echo "ðŸ¥ LocalStack Health: http://localhost:4566/_localstack/health"
          echo "ðŸŽ›ï¸ LocalStack Dashboard: http://localhost:4566/_localstack/cockpit"
          echo "ðŸ“‚ Repository: https://github.com/${{ github.repository }}"
          echo "ðŸ”„ Actions: https://github.com/${{ github.repository }}/actions"
          echo ""
          echo "ðŸ“ S3 BUCKET CONTENTS:"
          awslocal s3 ls s3://verison-devos-one-website --recursive --human-readable --summarize
          echo ""
          echo "ðŸ” TESTING WEBSITE RESPONSE..."
          if curl -s -I http://verison-devos-one-website.s3-website.us-east-1.localhost.localstack.cloud:4566 | grep -q "200 OK"; then
            echo "âœ… LocalStack website is responding successfully!"
          else
            echo "âš ï¸ LocalStack website may take a moment to be available"
          fi
          echo ""
          echo "ðŸš€ DEPLOYMENT COMPLETE!"
          echo "ðŸ’¡ Note: LocalStack runs only during CI. For permanent access, use GitHub Pages URL."
          echo "===================================="
          
      - name: ðŸ“¢ Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Successfully deployed to LocalStack + GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Pages (Permanent)**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "- **LocalStack (CI Only)**: http://verison-devos-one-website.s3-website.us-east-1.localhost.localstack.cloud:4566" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Infrastructure:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform infrastructure deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… S3 bucket created and configured" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Website hosting enabled" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Static files uploaded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Tech Stack:" >> $GITHUB_STEP_SUMMARY
          echo "- Next.js 16.1.6" >> $GITHUB_STEP_SUMMARY
          echo "- LocalStack (AWS Emulation)" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform (Infrastructure as Code)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Actions (CI/CD)" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Pages (Static Hosting)" >> $GITHUB_STEP_SUMMARY
